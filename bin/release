#!/usr/bin/env node

/**
 * Dependencies
 */

var AWS = require('aws-sdk');
var fs = require('fs');
var mime = require('mime');

/**
 * S3
 */

var s3 = new AWS.S3();

/**
 * Read dir
 */

var files = walk(__dirname + '/../build');

/**
 * Push each file to Amazon
 */

console.log('Uploading to', process.env.S3_BUCKET);
files.forEach(push);
console.log('Upload complete.');

/**
 * Push
 */

function push(file, callback) {
  var to = file.substring(__dirname.length + 3);
  s3.putObject({
    ACL: 'public-read',
    Body: fs.readFileSync(file),
    Bucket: process.env.AWS_S3_BUCKET,
    ContentType: mime.lookup(file),
    Key: to
  }, function(err, res) {
    console.log(err, res);
  });
}

/**
 * Walk
 */

function walk(dir) {
  var results = [];
  var list = fs.readdirSync(dir);
  list.forEach(function(file) {
    file = dir + '/' + file;
    var stat = fs.statSync(file);
    if (stat && stat.isDirectory()) results = results.concat(walk(file));
    else results.push(file);
  });

  return results;
}
