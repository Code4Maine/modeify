#!/usr/bin/env node

var Batch = require('batch');
var Commuter = require('../lib/commuter/model');
var geocode = require('../lib/geocode');

/**
 * Reverse geocode addresses and push them back into the commuter
 */

var batch = new Batch();
Commuter.find(function(err, commuters) {
  if (err) {
    console.error(err);
    process.exit(1);
  } else {
    commuters.forEach(function(commuter) {
      var opts = commuter.opts;
      if (opts && opts.from_ll && opts.from_ll.lat) {
        batch.push(function(done) {
          var ll = opts.reverse_commute
            ? opts.to_ll
            : opts.from_ll;
          commuter.reverseGeocode(ll, function(err) {
            if (err) {
              console.error(err);
            }
            done();
          });
        });
      }
    });

    batch.on('progress', function(e) {
      console.log(e.complete, '/', e.total);
    });

    batch.end(function(err) {
      if (err) {
        console.error(err);
        process.exit(1);
      } else {
        process.exit(0);
      }
    });
  }
});