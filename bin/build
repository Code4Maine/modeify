#!/usr/bin/env node

/**
 * Env
 */

var env = process.env.NODE_ENV = process.argv[2] || process.env.NODE_ENV;

/**
 * Dependencies
 */

var Builder = require('component-builder');
var component = require('../component.json');
var config = require('../config.json')[env];
var fs = require('fs');
var mkdir = require('mkdirp');
var myth = require('myth');
var path = require('path');
var resolve = path.resolve;
var sqwish = require('sqwish');
var uglify = require('uglify-js');
var write = fs.writeFileSync;

/**
 * Set the rest of the public config.
 */

config.env = env;
config.mapbox_map_id = process.env.MAPBOX_MAP_ID;
config.name = process.env.NAME;

/**
 * Build all
 */

component.local.forEach(build);

/**
 * Build.
 */

function build(bundle) {
  /**
   * Settings.
   */

  var dest = 'build/' + bundle;
  var production = env === 'production';

  /**
   * Builder.
   */

  var builder = new Builder(__dirname + '/..');
  builder.config.local = [bundle];

  builder.copyAssetsTo(__dirname + '/../' + dest);
  builder.prefixUrls(config.static_url + '/' + dest);
  builder.copyFiles(true);

  if (!production) {
    builder.development(true);
    builder.addSourceURLs(true);
  }

  builder.build(function (err, res) {
    if (err) throw err;
    mkdir.sync(__dirname + '/../' + dest);

    if (res.js) {
      var js = 'window.CONFIG=' + JSON.stringify(config) + ';' + res.require + res.js + ';require("' + bundle + '");';
      // if (production) js = uglify.minify(js, { fromString: true }).code;
      write(resolve(dest, 'build.js'), js);
    }

    if (res.css) {
      var css = myth(res.css);
      if (production) css = sqwish.minify(css);
      write(resolve(dest, 'build.css'), css);
    }
  });
}
